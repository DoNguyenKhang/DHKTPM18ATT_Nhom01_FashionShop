<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω ƒë∆°n h√†ng - Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/css/admin-sidebar.css">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .status-badge {
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <!-- Mobile Toggle Button -->
    <button class="sidebar-toggle" onclick="toggleSidebar()">
        <i class="bi bi-list"></i> Menu
    </button>

    <!-- Sidebar -->
    <div class="admin-sidebar" id="adminSidebar">
        <div class="sidebar-header">
            <h4><i class="bi bi-bag-heart-fill"></i> Fashion Shop</h4>
        </div>

        <div class="user-info" id="userInfo">
            <small class="user-role" id="userRole">ƒêang t·∫£i...</small>
            <div class="user-name">ƒêang t·∫£i...</div>
        </div>

        <nav>
            <a href="/dashboard">
                <i class="bi bi-speedometer2"></i> Dashboard
            </a>

            <div class="nav-section-title">QU·∫¢N L√ù</div>

            <a href="/admin/products">
                <i class="bi bi-box-seam"></i> Qu·∫£n l√Ω S·∫£n ph·∫©m
            </a>
            <a href="/admin/categories">
                <i class="bi bi-grid"></i> Qu·∫£n l√Ω Danh m·ª•c
            </a>
            <a href="/admin/brands">
                <i class="bi bi-tags"></i> Qu·∫£n l√Ω Th∆∞∆°ng hi·ªáu
            </a>
            <a href="/admin/orders" class="active">
                <i class="bi bi-cart-check"></i> Qu·∫£n l√Ω ƒê∆°n h√†ng
            </a>
            <a href="/admin/payments">
                <i class="bi bi-credit-card"></i> Qu·∫£n l√Ω Thanh to√°n
            </a>
            <a href="/admin/coupons">
                <i class="bi bi-tag"></i> Qu·∫£n l√Ω M√£ gi·∫£m gi√°
            </a>
            <a href="/admin/users">
                <i class="bi bi-people"></i> Qu·∫£n l√Ω Ng∆∞·ªùi d√πng
            </a>
            <a href="/admin/audit-logs">
                <i class="bi bi-file-text"></i> Nh·∫≠t k√Ω ho·∫°t ƒë·ªông
            </a>
            <a href="/admin/system-monitor">
                <i class="bi bi-activity"></i> Gi√°m s√°t H·ªá th·ªëng
            </a>

            <hr>

            <a href="/profile">
                <i class="bi bi-person-badge"></i> Th√¥ng tin c√° nh√¢n
            </a>
            <a href="/products">
                <i class="bi bi-house"></i> V·ªÅ trang ch·ªß
            </a>
            <a href="#" onclick="logout()">
                <i class="bi bi-box-arrow-right"></i> ƒêƒÉng xu·∫•t
            </a>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="admin-main-content">
        <div class="page-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2><i class="bi bi-cart-check"></i> Qu·∫£n l√Ω ƒê∆°n h√†ng</h2>
                    <p class="text-muted mb-0">T·ªïng s·ªë: <span id="totalOrders">0</span> ƒë∆°n h√†ng</p>
                </div>
                <div>
                    <button class="btn btn-primary" onclick="loadOrders()" id="refreshBtn">
                        <i class="bi bi-arrow-clockwise"></i> L√†m m·ªõi
                    </button>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="row g-3 mb-4">
            <div class="col-md-3">
                <div class="card border-warning">
                    <div class="card-body">
                        <h6 class="text-muted">Ch·ªù x·ª≠ l√Ω</h6>
                        <h3 class="text-warning" id="pendingCount">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-info">
                    <div class="card-body">
                        <h6 class="text-muted">ƒê√£ x√°c nh·∫≠n</h6>
                        <h3 class="text-info" id="confirmedCount">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-primary">
                    <div class="card-body">
                        <h6 class="text-muted">ƒêang giao</h6>
                        <h3 class="text-primary" id="shippingCount">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-success">
                    <div class="card-body">
                        <h6 class="text-muted">Ho√†n th√†nh</h6>
                        <h3 class="text-success" id="completedCount">0</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filter -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <input type="text" class="form-control" id="searchInput" placeholder="T√¨m m√£ ƒë∆°n, t√™n kh√°ch...">
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="statusFilter" onchange="filterOrders()">
                            <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                            <option value="PENDING">Ch·ªù x·ª≠ l√Ω</option>
                            <option value="CONFIRMED">ƒê√£ x√°c nh·∫≠n</option>
                            <option value="PACKING">ƒêang ƒë√≥ng g√≥i</option>
                            <option value="SHIPPING">ƒêang giao</option>
                            <option value="COMPLETED">Ho√†n th√†nh</option>
                            <option value="CANCELLED">ƒê√£ h·ªßy</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <input type="date" class="form-control" id="dateFrom">
                    </div>
                    <div class="col-md-3">
                        <input type="date" class="form-control" id="dateTo">
                    </div>
                </div>
            </div>
        </div>

        <!-- Orders Table -->
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>M√£ ƒë∆°n</th>
                                <th>Kh√°ch h√†ng</th>
                                <th>S·ªë ƒëi·ªán tho·∫°i</th>
                                <th>T·ªïng ti·ªÅn</th>
                                <th>Tr·∫°ng th√°i</th>
                                <th>Ng√†y ƒë·∫∑t</th>
                                <th>Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody">
                            <tr>
                                <td colspan="7" class="text-center">
                                    <div class="spinner-border text-primary" role="status"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Detail Modal -->
    <div class="modal fade" id="orderDetailModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Chi ti·∫øt ƒë∆°n h√†ng</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="orderDetailContent">
                    <!-- Content will be loaded dynamically -->
                </div>
                <div class="modal-footer">
                    <a href="/admin/payments" class="btn btn-outline-primary">
                        <i class="bi bi-credit-card"></i> Qu·∫£n l√Ω thanh to√°n
                    </a>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/auth.js"></script>
    <script>
        // Check order management access (ADMIN or STAFF_SALES only)
        checkOrderAccess();

        const user = getUser();
        if (user) {
            const roleDisplay = getUserRoleDisplay();
            document.getElementById('userRole').textContent = roleDisplay;
            document.querySelector('.user-name').textContent = user.fullName || user.email;
        }

        let allOrders = [];

        loadOrders();

        async function loadOrders() {
            try {
                // Show loading state
                const refreshBtn = document.getElementById('refreshBtn');
                if (refreshBtn) {
                    refreshBtn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> <span class="spinner-border spinner-border-sm"></span>';
                    refreshBtn.disabled = true;
                }

                const response = await fetchWithAuth('/api/orders?size=100');
                const data = await response.json();
                allOrders = data.content || data || [];
                displayOrders(allOrders);
                updateStats(allOrders);

                // Restore button
                if (refreshBtn) {
                    refreshBtn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> L√†m m·ªõi';
                    refreshBtn.disabled = false;
                }
            } catch (error) {
                console.error('Error loading orders:', error);
                showError('L·ªói t·∫£i danh s√°ch ƒë∆°n h√†ng');

                // Restore button on error
                const refreshBtn = document.getElementById('refreshBtn');
                if (refreshBtn) {
                    refreshBtn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> L√†m m·ªõi';
                    refreshBtn.disabled = false;
                }
            }
        }

        function updateStats(orders) {
            const stats = {
                PENDING: 0,
                CONFIRMED: 0,
                SHIPPING: 0,
                COMPLETED: 0
            };

            orders.forEach(order => {
                if (stats.hasOwnProperty(order.status)) {
                    stats[order.status]++;
                }
            });

            document.getElementById('pendingCount').textContent = stats.PENDING;
            document.getElementById('confirmedCount').textContent = stats.CONFIRMED;
            document.getElementById('shippingCount').textContent = stats.SHIPPING;
            document.getElementById('completedCount').textContent = stats.COMPLETED;
        }

        function displayOrders(orders) {
            const tbody = document.getElementById('ordersTableBody');
            document.getElementById('totalOrders').textContent = orders.length;

            if (!orders || orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o</td></tr>';
                return;
            }

            tbody.innerHTML = orders.map(order => {
                const statusConfig = getStatusConfig(order.status);
                return `
                    <tr>
                        <td><strong>${order.code}</strong></td>
                        <td>${order.shipName}</td>
                        <td>${order.shipPhone}</td>
                        <td>
                            <strong>${formatCurrency(order.grandTotal)}</strong>
                            <br><small class="badge ${getPaymentStatusBadge(order.paymentStatus)}">${getPaymentStatusText(order.paymentStatus)}</small>
                        </td>
                        <td><span class="badge ${statusConfig.class} status-badge">${statusConfig.text}</span></td>
                        <td>${formatDate(order.placedAt)}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="viewOrderDetail(${order.id})" title="Xem chi ti·∫øt">
                                <i class="bi bi-eye"></i>
                            </button>
                            ${order.status === 'PENDING' ? `
                                <button class="btn btn-sm btn-success" onclick="updateStatus(${order.id}, 'CONFIRMED')" title="X√°c nh·∫≠n">
                                    <i class="bi bi-check"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="cancelOrder(${order.id})" title="H·ªßy ƒë∆°n">
                                    <i class="bi bi-x-circle"></i>
                                </button>
                            ` : ''}
                            ${order.status === 'CONFIRMED' ? `
                                <button class="btn btn-sm btn-info" onclick="updateStatus(${order.id}, 'PACKING')" title="ƒê√≥ng g√≥i">
                                    <i class="bi bi-box-seam"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="cancelOrder(${order.id})" title="H·ªßy ƒë∆°n">
                                    <i class="bi bi-x-circle"></i>
                                </button>
                            ` : ''}
                            ${order.status === 'PACKING' ? `
                                <button class="btn btn-sm btn-primary" onclick="updateStatus(${order.id}, 'SHIPPING')" title="Giao h√†ng">
                                    <i class="bi bi-truck"></i>
                                </button>
                            ` : ''}
                            ${order.status === 'SHIPPING' ? `
                                <button class="btn btn-sm btn-success" onclick="updateStatus(${order.id}, 'COMPLETED')" title="Ho√†n th√†nh">
                                    <i class="bi bi-check-circle"></i>
                                </button>
                            ` : ''}
                            ${order.status === 'COMPLETED' && order.paymentStatus === 'PAID' ? `
                                <button class="btn btn-sm btn-warning" onclick="processRefund(${order.id})" title="Ho√†n ti·ªÅn">
                                    <i class="bi bi-arrow-return-left"></i> Ho√†n ti·ªÅn
                                </button>
                            ` : ''}
                            ${order.status === 'CANCELLED' && order.paymentStatus === 'PAID' ? `
                                <button class="btn btn-sm btn-warning" onclick="processRefund(${order.id})" title="Ho√†n ti·ªÅn">
                                    <i class="bi bi-arrow-return-left"></i> Ho√†n ti·ªÅn
                                </button>
                            ` : ''}
                            ${(order.status === 'REFUNDED' || (order.status === 'CANCELLED' && order.paymentStatus === 'REFUNDED')) ? `
                                <span class="text-success"><small><i class="bi bi-check-circle"></i> ƒê√£ ho√†n ti·ªÅn</small></span>
                            ` : ''}

                        </td>
                    </tr>
                `;
            }).join('');
        }

        function getStatusConfig(status) {
            const configs = {
                PENDING: { class: 'bg-warning', text: 'Ch·ªù x·ª≠ l√Ω' },
                CONFIRMED: { class: 'bg-info', text: 'ƒê√£ x√°c nh·∫≠n' },
                PACKING: { class: 'bg-primary', text: 'ƒêang ƒë√≥ng g√≥i' },
                SHIPPING: { class: 'bg-primary', text: 'ƒêang giao' },
                COMPLETED: { class: 'bg-success', text: 'Ho√†n th√†nh' },
                CANCELLED: { class: 'bg-danger', text: 'ƒê√£ h·ªßy' }
            };
            return configs[status] || { class: 'bg-secondary', text: status };
        }

        function filterOrders() {
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            const status = document.getElementById('statusFilter').value;

            let filtered = allOrders.filter(order => {
                const matchSearch = !searchText ||
                    order.code.toLowerCase().includes(searchText) ||
                    order.shipName.toLowerCase().includes(searchText);

                const matchStatus = !status || order.status === status;

                return matchSearch && matchStatus;
            });

            displayOrders(filtered);
        }

        async function viewOrderDetail(id) {
            try {
                // Add timestamp to prevent caching
                const timestamp = new Date().getTime();
                const response = await fetchWithAuth(`/api/orders/${id}?_t=${timestamp}`);
                const order = await response.json();

                const statusConfig = getStatusConfig(order.status);
                const paymentMethodText = getPaymentMethodText(order.paymentMethod);
                const paymentStatusConfig = getPaymentStatusConfig(order.paymentStatus);

                const content = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Th√¥ng tin ƒë∆°n h√†ng</h6>
                            <p><strong>M√£ ƒë∆°n:</strong> ${order.code}</p>
                            <p><strong>Tr·∫°ng th√°i:</strong> <span class="badge ${statusConfig.class}">${statusConfig.text}</span></p>
                            <p><strong>Ng√†y ƒë·∫∑t:</strong> ${formatDate(order.placedAt)}</p>
                            <p><strong>Ghi ch√∫:</strong> ${order.note || 'Kh√¥ng c√≥'}</p>
                        </div>
                        <div class="col-md-6">
                            <h6>Th√¥ng tin giao h√†ng</h6>
                            <p><strong>Ng∆∞·ªùi nh·∫≠n:</strong> ${order.shipName}</p>
                            <p><strong>SƒêT:</strong> ${order.shipPhone}</p>
                            <p><strong>ƒê·ªãa ch·ªâ:</strong> ${order.shipLine1}, ${order.shipWard}, ${order.shipDistrict}, ${order.shipCity}</p>
                        </div>
                    </div>
                    <hr>
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6><i class="bi bi-credit-card"></i> Th√¥ng tin thanh to√°n</h6>
                            <div class="card bg-light">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p class="mb-2"><strong>Ph∆∞∆°ng th·ª©c:</strong>
                                                <span class="badge bg-primary">${paymentMethodText}</span>
                                            </p>
                                            <p class="mb-2"><strong>Tr·∫°ng th√°i thanh to√°n:</strong>
                                                <span class="badge ${paymentStatusConfig.class}">${paymentStatusConfig.text}</span>
                                            </p>
                                        </div>
                                        <div class="col-md-6">
                                            ${order.paymentTransactionId ? `<p class="mb-2"><strong>M√£ giao d·ªãch:</strong> <code>${order.paymentTransactionId}</code></p>` : ''}
                                            ${order.paymentTime ? `<p class="mb-2"><strong>Th·ªùi gian thanh to√°n:</strong> ${formatDate(order.paymentTime)}</p>` : ''}
                                            ${!order.paymentTransactionId && !order.paymentTime ? '<p class="text-muted mb-2"><em>Ch∆∞a c√≥ th√¥ng tin giao d·ªãch</em></p>' : ''}
                                        </div>
                                    </div>
                                    ${order.paymentMethod === 'COD' && order.paymentStatus === 'PAID' ? `
                                    <div class="alert alert-success mb-0 mt-3">
                                        <i class="bi bi-check-circle-fill"></i>
                                        <strong>ƒê√£ thu ti·ªÅn COD th√†nh c√¥ng!</strong>
                                        ${order.paymentTime ? ` - Th·ªùi gian: ${formatDate(order.paymentTime)}` : ''}
                                    </div>
                                    ` : ''}
                                    ${order.paymentMethod === 'COD' && order.paymentStatus === 'UNPAID' ? `
                                    <div class="alert alert-warning mb-0 mt-3">
                                        <i class="bi bi-exclamation-triangle-fill"></i>
                                        <strong>Ch∆∞a thu ti·ªÅn COD</strong> - Vui l√≤ng x√°c nh·∫≠n khi ƒë√£ thu ti·ªÅn t·ª´ kh√°ch h√†ng
                                    </div>
                                    ` : ''}
                                    ${order.paymentMethod === 'COD' && order.paymentStatus === 'FAILED' ? `
                                    <div class="alert alert-danger mb-0 mt-3">
                                        <i class="bi bi-x-circle-fill"></i>
                                        <strong>Thanh to√°n COD th·∫•t b·∫°i</strong>
                                        ${order.paymentTransactionId ? ` - L√Ω do: ${order.paymentTransactionId}` : ''}
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <h6>Chi ti·∫øt s·∫£n ph·∫©m</h6>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>S·∫£n ph·∫©m</th>
                                <th>SKU</th>
                                <th>S·ªë l∆∞·ª£ng</th>
                                <th>ƒê∆°n gi√°</th>
                                <th>Th√†nh ti·ªÅn</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${order.items.map(item => `
                                <tr>
                                    <td>
                                        ${item.productName}<br>
                                        <small class="text-muted">${item.colorName || ''} ${item.sizeName || ''}</small>
                                    </td>
                                    <td>${item.sku}</td>
                                    <td>${item.quantity}</td>
                                    <td>${formatCurrency(item.unitPrice)}</td>
                                    <td>${formatCurrency(item.lineTotal)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <div class="row">
                        <div class="col-md-6 offset-md-6">
                            <table class="table">
                                <tr>
                                    <td>T·∫°m t√≠nh:</td>
                                    <td class="text-end">${formatCurrency(order.subtotal)}</td>
                                </tr>
                                <tr>
                                    <td>Gi·∫£m gi√° ${order.couponCode ? `(<code>${order.couponCode}</code>)` : ''}:</td>
                                    <td class="text-end text-danger">-${formatCurrency(order.discountTotal)}</td>
                                </tr>
                                ${order.loyaltyPointsUsed && order.loyaltyPointsUsed > 0 ? `
                                <tr>
                                    <td><i class="bi bi-star-fill text-warning"></i> ƒêi·ªÉm t√≠ch l≈©y (${order.loyaltyPointsUsed.toLocaleString()} ƒëi·ªÉm):</td>
                                    <td class="text-end text-success">-${formatCurrency(order.loyaltyPointsUsed * 1000)}</td>
                                </tr>
                                ` : ''}
                                <tr>
                                    <td>Ph√≠ ship:</td>
                                    <td class="text-end">${formatCurrency(order.shippingFee)}</td>
                                </tr>
                                <tr>
                                    <th>T·ªïng c·ªông:</th>
                                    <th class="text-end text-primary">${formatCurrency(order.grandTotal)}</th>
                                </tr>
                                ${order.loyaltyPointsEarned && order.loyaltyPointsEarned > 0 ? `
                                <tr>
                                    <td colspan="2" class="text-center">
                                        <div class="alert alert-success mb-0 mt-2">
                                            <i class="bi bi-star-fill"></i>
                                            Kh√°ch h√†ng ${order.status === 'COMPLETED' ? 'ƒë√£ nh·∫≠n' : 's·∫Ω nh·∫≠n'}
                                            <strong>${order.loyaltyPointsEarned.toLocaleString()} ƒëi·ªÉm</strong> t√≠ch l≈©y
                                        </div>
                                    </td>
                                </tr>
                                ` : ''}
                            </table>
                        </div>
                    </div>
                `;

                document.getElementById('orderDetailContent').innerHTML = content;
                new bootstrap.Modal(document.getElementById('orderDetailModal')).show();
            } catch (error) {
                console.error('Error loading order detail:', error);
                alert('L·ªói t·∫£i chi ti·∫øt ƒë∆°n h√†ng');
            }
        }

        function getPaymentMethodText(method) {
            const methods = {
                COD: 'Thanh to√°n khi nh·∫≠n h√†ng (COD)',
                VNPAY: 'VNPAY',
                MOMO: 'V√≠ MoMo',
                ZALOPAY: 'ZaloPay'
            };
            return methods[method] || method || 'Ch∆∞a x√°c ƒë·ªãnh';
        }

        function getPaymentStatusConfig(status) {
            const configs = {
                UNPAID: { class: 'bg-warning', text: 'Ch∆∞a thanh to√°n' },
                PAID: { class: 'bg-success', text: 'ƒê√£ thanh to√°n' },
                FAILED: { class: 'bg-danger', text: 'Thanh to√°n th·∫•t b·∫°i' },
                REFUNDED: { class: 'bg-info', text: 'ƒê√£ ho√†n ti·ªÅn' }
            };
            return configs[status] || { class: 'bg-secondary', text: status || 'Ch∆∞a x√°c ƒë·ªãnh' };
        }

        async function updateStatus(id, status) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën c·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n h√†ng?')) {
                return;
            }

            try {
                const response = await fetchWithAuth(`/api/orders/${id}/status?status=${status}`, {
                    method: 'PUT'
                });

                if (response.ok) {
                    alert('C·∫≠p nh·∫≠t tr·∫°ng th√°i th√†nh c√¥ng!');
                    loadOrders();
                } else {
                    const error = await response.json();
                    alert('Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i: ' + (error.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'));
                }
            } catch (error) {
                console.error('Error updating status:', error);
                alert('C√≥ l·ªói x·∫£y ra!');
            }
        }

        async function cancelOrder(id) {
            // Get order info first to check payment status
            let orderInfo = null;
            try {
                const response = await fetchWithAuth(`/api/orders/${id}`);
                if (response.ok) {
                    orderInfo = await response.json();
                }
            } catch (e) {
                console.error('Error fetching order info:', e);
            }

            const reason = prompt('Nh·∫≠p l√Ω do h·ªßy ƒë∆°n h√†ng:');

            if (!reason || reason.trim() === '') {
                alert('Vui l√≤ng nh·∫≠p l√Ω do h·ªßy ƒë∆°n!');
                return;
            }

            let confirmMessage = 'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën H·ª¶Y ƒë∆°n h√†ng n√†y?\n\nL√Ω do: ' + reason + '\n\nH√†nh ƒë·ªông n√†y s·∫Ω:\n- Ho√†n l·∫°i s·ªë l∆∞·ª£ng s·∫£n ph·∫©m\n- Ho√†n ƒëi·ªÉm t√≠ch l≈©y (n·∫øu c√≥)\n- Kh√¥ng th·ªÉ ho√†n t√°c!';

            if (orderInfo && orderInfo.paymentStatus === 'PAID') {
                confirmMessage = 'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën H·ª¶Y ƒë∆°n h√†ng n√†y?\n\nL√Ω do: ' + reason + '\n\n‚ö†Ô∏è ƒê∆†N H√ÄNG ƒê√É THANH TO√ÅN\n\nH√†nh ƒë·ªông n√†y s·∫Ω:\n- ƒê√°nh d·∫•u ƒë∆°n h√†ng c·∫ßn ho√†n ti·ªÅn\n- Ho√†n l·∫°i s·ªë l∆∞·ª£ng s·∫£n ph·∫©m v√†o kho\n- Ho√†n l·∫°i ƒëi·ªÉm t√≠ch l≈©y\n- Y√äU C·∫¶U b·∫°n x·ª≠ l√Ω ho√†n ti·ªÅn th·ª±c t·∫ø sau ƒë√≥!';
            }

            if (!confirm(confirmMessage)) {
                return;
            }

            try {
                // For admin, we still use the status endpoint because admin needs to provide reason
                // The updateOrderStatus method in OrderService handles refund logic
                const response = await fetchWithAuth(`/api/orders/${id}/status?status=CANCELLED`, {
                    method: 'PUT'
                });

                if (response.ok) {
                    if (orderInfo && orderInfo.paymentStatus === 'PAID') {
                        alert('‚úÖ H·ªßy ƒë∆°n h√†ng th√†nh c√¥ng!\n\n‚ö†Ô∏è L∆ØU √ù HO√ÄN TI·ªÄN:\n- ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c ƒë√°nh d·∫•u REFUNDED\n- S·ªë l∆∞·ª£ng s·∫£n ph·∫©m ƒë√£ ƒë∆∞·ª£c ho√†n l·∫°i kho\n- ƒêi·ªÉm t√≠ch l≈©y ƒë√£ ƒë∆∞·ª£c ho√†n l·∫°i\n\nüìù B·∫†N C·∫¶N:\nV√†o "Qu·∫£n l√Ω thanh to√°n" ho·∫∑c c·ªïng ' + getPaymentMethodText(orderInfo.paymentMethod) + ' ƒë·ªÉ ho√†n ti·ªÅn th·ª±c t·∫ø cho kh√°ch h√†ng!');
                    } else {
                        alert('‚úÖ H·ªßy ƒë∆°n h√†ng th√†nh c√¥ng!\n\n- S·ªë l∆∞·ª£ng s·∫£n ph·∫©m ƒë√£ ƒë∆∞·ª£c ho√†n l·∫°i kho\n- ƒêi·ªÉm t√≠ch l≈©y ƒë√£ ƒë∆∞·ª£c ho√†n l·∫°i (n·∫øu c√≥)');
                    }
                    loadOrders();
                } else {
                    const error = await response.json();
                    alert('‚ùå Kh√¥ng th·ªÉ h·ªßy ƒë∆°n h√†ng: ' + (error.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'));
                }
            } catch (error) {
                console.error('Error cancelling order:', error);
                alert('‚ùå C√≥ l·ªói x·∫£y ra khi h·ªßy ƒë∆°n h√†ng!');
            }
        }

        function showError(message) {
            const tbody = document.getElementById('ordersTableBody');
            tbody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">${message}</td></tr>`;
        }

        async function processRefund(id) {
            const reason = prompt('Nh·∫≠p l√Ω do ho√†n ti·ªÅn:\n(V√≠ d·ª•: Kh√°ch h√†ng y√™u c·∫ßu ho√†n ti·ªÅn, s·∫£n ph·∫©m l·ªói, giao h√†ng ch·∫≠m...)');

            if (!reason || reason.trim() === '') {
                alert('Vui l√≤ng nh·∫≠p l√Ω do ho√†n ti·ªÅn!');
                return;
            }

            if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën HO√ÄN TI·ªÄN cho ƒë∆°n h√†ng n√†y?\n\nL√Ω do: ' + reason + '\n\nH√†nh ƒë·ªông n√†y s·∫Ω:\n- ƒê√°nh d·∫•u ƒë∆°n h√†ng l√† ƒë√£ ho√†n ti·ªÅn\n- Ho√†n l·∫°i s·ªë l∆∞·ª£ng s·∫£n ph·∫©m v√†o kho\n- Ho√†n l·∫°i ƒëi·ªÉm t√≠ch l≈©y\n- C·∫ßn x·ª≠ l√Ω ho√†n ti·ªÅn th·ª±c t·∫ø cho kh√°ch h√†ng!')) {
                return;
            }

            try {
                const response = await fetchWithAuth(`/api/orders/${id}/refund`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ reason: reason })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    alert('‚úÖ X·ª≠ l√Ω ho√†n ti·ªÅn th√†nh c√¥ng!\n\n‚ö†Ô∏è L∆ØU √ù:\n- H·ªá th·ªëng ƒë√£ c·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n h√†ng\n- ƒê√£ ho√†n l·∫°i s·ªë l∆∞·ª£ng s·∫£n ph·∫©m v√†o kho\n- ƒê√£ ho√†n l·∫°i ƒëi·ªÉm t√≠ch l≈©y\n\nüìù B·∫†N C·∫¶N:\n- X·ª≠ l√Ω ho√†n ti·ªÅn th·ª±c t·∫ø cho kh√°ch h√†ng qua: ' + getPaymentMethodText(result.paymentMethod || 'Ph∆∞∆°ng th·ª©c thanh to√°n'));
                    loadOrders();
                } else {
                    alert('‚ùå Kh√¥ng th·ªÉ ho√†n ti·ªÅn: ' + (result.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'));
                }
            } catch (error) {
                console.error('Error processing refund:', error);
                alert('‚ùå C√≥ l·ªói x·∫£y ra khi x·ª≠ l√Ω ho√†n ti·ªÅn!');
            }
        }

        function getPaymentStatusBadge(status) {
            const badges = {
                'UNPAID': 'bg-warning',
                'PAID': 'bg-success',
                'REFUNDED': 'bg-info',
                'FAILED': 'bg-danger'
            };
            return badges[status] || 'bg-secondary';
        }

        function getPaymentStatusText(status) {
            const texts = {
                'UNPAID': 'Ch∆∞a thanh to√°n',
                'PAID': 'ƒê√£ thanh to√°n',
                'REFUNDED': 'ƒê√£ ho√†n ti·ªÅn',
                'FAILED': 'Th·∫•t b·∫°i'
            };
            return texts[status] || status;
        }

        function getPaymentMethodText(method) {
            const methods = {
                'COD': 'COD (Ti·ªÅn m·∫∑t)',
                'VNPAY': 'VNPay',
                'MOMO': 'MoMo',
                'ZALOPAY': 'ZaloPay'
            };
            return methods[method] || method;
        }

        // Utility functions
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('vi-VN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatCurrency(amount) {
            if (amount === null || amount === undefined) return '0 ‚Ç´';
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/auth/login';
        }

        // Search on Enter
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') filterOrders();
        });

        // Auto reload when page becomes visible again (user returns from payments page)
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                console.log('Page visible - reloading orders...');
                loadOrders();
            }
        });

        // Also reload when window gains focus
        window.addEventListener('focus', function() {
            console.log('Window focused - reloading orders...');
            loadOrders();
        });
    </script>
</body>
</html>

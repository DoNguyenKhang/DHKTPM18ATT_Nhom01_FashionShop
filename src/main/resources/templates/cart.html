<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giỏ hàng - Fashion Shop</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        /* Navbar Styles */
        .navbar-custom {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .navbar-custom .navbar-brand {
            color: white !important;
            font-weight: bold;
            font-size: 1.4rem;
            transition: transform 0.3s;
        }
        .navbar-custom .navbar-brand:hover {
            transform: scale(1.05);
        }
        .navbar-custom .nav-link {
            color: rgba(255,255,255,0.9) !important;
            font-weight: 500;
            padding: 0.5rem 1rem !important;
            transition: all 0.3s;
            border-radius: 5px;
            margin: 0 0.2rem;
        }
        .navbar-custom .nav-link:hover {
            background: rgba(255,255,255,0.2);
            color: white !important;
        }
        .navbar-custom .nav-link.active {
            background: rgba(255,255,255,0.25);
            color: white !important;
        }
        .navbar-custom .btn-register {
            background: white;
            color: #667eea;
            font-weight: 600;
            border: none;
            padding: 0.5rem 1.5rem;
            border-radius: 25px;
            transition: all 0.3s;
        }
        .navbar-custom .btn-register:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255,255,255,0.3);
        }
        .navbar-custom .dropdown-menu {
            border: none;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            border-radius: 10px;
            margin-top: 0.5rem;
        }
        .navbar-custom .dropdown-item {
            padding: 0.7rem 1.5rem;
            transition: all 0.3s;
        }
        .navbar-custom .dropdown-item:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .cart-item-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-custom sticky-top">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="bi bi-bag-heart-fill"></i> Fashion Shop
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto align-items-lg-center">
                    <li class="nav-item">
                        <a class="nav-link" href="/">
                            <i class="bi bi-house-door"></i> Trang chủ
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/products">
                            <i class="bi bi-box-seam"></i> Sản phẩm
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/cart">
                            <i class="bi bi-cart3"></i> Giỏ hàng
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/orders">
                            <i class="bi bi-bag-check"></i> Đơn hàng
                        </a>
                    </li>
                    <li class="nav-item dropdown" id="userDropdown" style="display: none;">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-person-circle"></i> <span id="userName"></span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="/profile">
                                <i class="bi bi-person-badge"></i> Thông tin cá nhân
                            </a></li>
                            <li><a class="dropdown-item" href="/orders">
                                <i class="bi bi-bag-check"></i> Đơn hàng của tôi
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="logout()">
                                <i class="bi bi-box-arrow-right"></i> Đăng xuất
                            </a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container my-5">
        <h2 class="mb-4"><i class="bi bi-cart3"></i> Giỏ hàng của bạn</h2>

        <div class="row">
            <!-- Cart Items -->
            <div class="col-lg-8">
                <div id="cartItems">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p>Đang tải giỏ hàng...</p>
                    </div>
                </div>
            </div>

            <!-- Cart Summary -->
            <div class="col-lg-4">
                <div class="card sticky-top" style="top: 20px;">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Tóm tắt đơn hàng</h5>
                    </div>
                    <div class="card-body">
                        <!-- Coupon Code Input -->
                        <div class="mb-3">
                            <label class="form-label">Mã giảm giá</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="couponCode"
                                       placeholder="Nhập mã giảm giá"
                                       style="text-transform: uppercase;">
                                <button class="btn btn-outline-primary" onclick="applyCoupon()" id="applyCouponBtn">
                                    Áp dụng
                                </button>
                            </div>
                            <div id="couponMessage" class="mt-2"></div>
                            <div id="couponInfo" class="mt-2" style="display: none;">
                                <div class="alert alert-success d-flex justify-content-between align-items-center p-2 mb-0">
                                    <small>
                                        <i class="bi bi-check-circle"></i>
                                        <span id="couponCodeApplied"></span>
                                    </small>
                                    <button class="btn btn-sm btn-link text-danger p-0" onclick="removeCoupon()">
                                        <i class="bi bi-x-circle"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Tạm tính:</span>
                            <strong id="subtotal">0 ₫</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Giảm giá:</span>
                            <strong class="text-danger" id="discount">0 ₫</strong>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between mb-3">
                            <h5>Tổng cộng:</h5>
                            <h5 class="text-primary" id="total">0 ₫</h5>
                        </div>
                        <button class="btn btn-primary w-100" id="checkoutBtn" onclick="checkout()" disabled>
                            <i class="bi bi-credit-card"></i> Thanh toán
                        </button>
                        <button class="btn btn-outline-danger w-100 mt-2" onclick="clearCart()">
                            <i class="bi bi-trash"></i> Xóa giỏ hàng
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Checkout Modal -->
    <div class="modal fade" id="checkoutModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Thông tin giao hàng</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="checkoutForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Họ tên <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="shipName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Số điện thoại <span class="text-danger">*</span></label>
                                <input type="tel" class="form-control" id="shipPhone" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Địa chỉ <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="shipLine1" placeholder="Số nhà, tên đường" required>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Phường/Xã <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="shipWard" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Quận/Huyện <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="shipDistrict" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Tỉnh/TP <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="shipCity" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ghi chú</label>
                            <textarea class="form-control" id="orderNote" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Phương thức thanh toán</label>
                            <div>
                                <input type="radio" name="paymentMethod" value="COD" id="paymentCOD" checked>
                                <label for="paymentCOD"> Thanh toán khi nhận hàng</label>
                            </div>
                            <div>
                                <input type="radio" name="paymentMethod" value="VNPAY" id="paymentVNPAY">
                                <label for="paymentVNPAY"> Thanh toán qua VNPay</label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary" onclick="submitOrder()">
                        <i class="bi bi-check-circle"></i> Đặt hàng
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/auth.js"></script>
    <script>
        // Check authentication
        if (!checkAuth()) {
            window.location.href = '/login';
        }

        const user = getUser();
        document.getElementById('userName').textContent = user.fullName || user.username;

        let cart = null;
        let appliedCoupon = null;
        let calculatedDiscount = 0;

        // Load cart
        async function loadCart() {
            try {
                const response = await fetchWithAuth('/api/cart');
                if (response.ok) {
                    cart = await response.json();
                    displayCart(cart);
                } else {
                    showError('Không thể tải giỏ hàng');
                }
            } catch (error) {
                console.error('Error loading cart:', error);
                showError('Có lỗi xảy ra khi tải giỏ hàng');
            }
        }

        function displayCart(cart) {
            const container = document.getElementById('cartItems');

            if (!cart || !cart.items || cart.items.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-cart-x" style="font-size: 5rem; color: #ccc;"></i>
                        <p class="text-muted mt-3">Giỏ hàng của bạn đang trống</p>
                        <a href="/products" class="btn btn-primary">Tiếp tục mua sắm</a>
                    </div>
                `;
                document.getElementById('checkoutBtn').disabled = true;
                updateSummary(0, 0, 0);
                return;
            }

            // Check if any item is out of stock or has insufficient stock
            const hasOutOfStock = cart.items.some(item => item.outOfStock);
            const hasInsufficientStock = cart.items.some(item => item.insufficientStock);

            container.innerHTML = cart.items.map(item => {
                const isOutOfStock = item.outOfStock;
                const isInsufficientStock = item.insufficientStock && !isOutOfStock;
                const isDisabled = isOutOfStock || isInsufficientStock;

                return `
                <div class="card mb-3 ${isDisabled ? 'border-danger' : ''}">
                    <div class="card-body ${isDisabled ? 'bg-light' : ''}">
                        <div class="row align-items-center">
                            <div class="col-md-2">
                                <img src="${item.imageUrl || 'https://via.placeholder.com/80'}"
                                     class="cart-item-image rounded ${isDisabled ? 'opacity-50' : ''}"
                                     alt="${item.productName}">
                            </div>
                            <div class="col-md-4">
                                <h6 class="mb-1">${item.productName}</h6>
                                <small class="text-muted">
                                    ${item.colorName ? `Màu: ${item.colorName}` : ''}
                                    ${item.sizeName ? `| Size: ${item.sizeName}` : ''}
                                </small>
                                <br>
                                ${isOutOfStock ? `
                                    <span class="badge bg-danger mt-2">
                                        <i class="bi bi-x-circle"></i> Hết hàng
                                    </span>
                                ` : isInsufficientStock ? `
                                    <span class="badge bg-warning text-dark mt-2">
                                        <i class="bi bi-exclamation-triangle"></i>
                                        Chỉ còn ${item.availableStock} sản phẩm
                                    </span>
                                ` : `
                                    <small class="text-success mt-2">
                                        <i class="bi bi-check-circle"></i>
                                        Còn ${item.availableStock} sản phẩm
                                    </small>
                                `}
                            </div>
                            <div class="col-md-2">
                                <strong class="text-primary ${isDisabled ? 'text-muted' : ''}">${formatCurrency(item.unitPrice)}</strong>
                            </div>
                            <div class="col-md-2">
                                <div class="input-group input-group-sm">
                                    <button class="btn btn-outline-secondary"
                                            onclick="updateQuantity(${item.id}, ${item.quantity - 1})"
                                            ${isDisabled ? 'disabled' : ''}>
                                        <i class="bi bi-dash"></i>
                                    </button>
                                    <input type="text" class="form-control text-center"
                                           value="${item.quantity}" readonly>
                                    <button class="btn btn-outline-secondary"
                                            onclick="updateQuantity(${item.id}, ${item.quantity + 1})"
                                            ${isDisabled || item.quantity >= item.availableStock ? 'disabled' : ''}>
                                        <i class="bi bi-plus"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-2 text-end">
                                <strong class="${isDisabled ? 'text-muted' : ''}">${formatCurrency(item.lineTotal)}</strong>
                                <br>
                                <button class="btn btn-sm btn-outline-danger mt-2" onclick="removeItem(${item.id})">
                                    <i class="bi bi-trash"></i> Xóa
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            }).join('');

            // Show warning if any item has stock issues
            if (hasOutOfStock || hasInsufficientStock) {
                const warningDiv = document.createElement('div');
                warningDiv.className = 'alert alert-warning mb-3';
                warningDiv.innerHTML = `
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Lưu ý:</strong>
                    ${hasOutOfStock ? 'Một số sản phẩm trong giỏ hàng đã hết hàng. ' : ''}
                    ${hasInsufficientStock ? 'Một số sản phẩm không đủ số lượng tồn kho. ' : ''}
                    Vui lòng xóa hoặc điều chỉnh số lượng trước khi thanh toán.
                `;
                container.insertAdjacentElement('afterbegin', warningDiv);
            }

            const subtotal = cart.subtotal || 0;
            const discount = appliedCoupon ? calculatedDiscount : 0;
            const total = subtotal - discount;

            updateSummary(subtotal, discount, total);

            // Disable checkout button if there are stock issues
            document.getElementById('checkoutBtn').disabled = hasOutOfStock || hasInsufficientStock;
        }

        function updateSummary(subtotal, discount, total) {
            document.getElementById('subtotal').textContent = formatCurrency(subtotal);
            document.getElementById('discount').textContent = '-' + formatCurrency(discount);
            document.getElementById('total').textContent = formatCurrency(total);
        }

        // Apply coupon code
        async function applyCoupon() {
            const couponCode = document.getElementById('couponCode').value.trim().toUpperCase();

            if (!couponCode) {
                showCouponMessage('Vui lòng nhập mã giảm giá', 'danger');
                return;
            }

            if (!cart || !cart.items || cart.items.length === 0) {
                showCouponMessage('Giỏ hàng trống, không thể áp dụng mã giảm giá', 'danger');
                return;
            }

            const applyBtn = document.getElementById('applyCouponBtn');
            const originalText = applyBtn.innerHTML;
            applyBtn.disabled = true;
            applyBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

            try {
                // Call API to validate coupon
                const response = await fetchWithAuth(`/api/coupons/validate?code=${couponCode}&orderAmount=${cart.subtotal}`);

                if (response.ok) {
                    const coupon = await response.json();
                    appliedCoupon = coupon;

                    // Calculate discount
                    let discount = 0;
                    if (coupon.type === 'PERCENT') {
                        discount = (cart.subtotal * coupon.value) / 100;
                        if (coupon.maxDiscount && discount > coupon.maxDiscount) {
                            discount = coupon.maxDiscount;
                        }
                    } else {
                        discount = coupon.value;
                    }

                    calculatedDiscount = discount;

                    // Show success message
                    const discountInfo = coupon.type === 'PERCENT'
                        ? `Giảm ${coupon.value}% (tối đa ${formatCurrency(coupon.maxDiscount || discount)})`
                        : `Giảm ${formatCurrency(coupon.value)}`;

                    showCouponMessage(`Áp dụng thành công! ${discountInfo}`, 'success');
                    document.getElementById('couponCodeApplied').textContent = couponCode;
                    document.getElementById('couponInfo').style.display = 'block';
                    document.getElementById('couponCode').disabled = true;
                    applyBtn.style.display = 'none';

                    // Update summary
                    updateSummary(cart.subtotal, discount, cart.subtotal - discount);
                } else {
                    const error = await response.json();
                    showCouponMessage(error.message || 'Mã giảm giá không hợp lệ', 'danger');
                    appliedCoupon = null;
                    calculatedDiscount = 0;
                }
            } catch (error) {
                console.error('Error applying coupon:', error);
                showCouponMessage('Có lỗi xảy ra khi áp dụng mã giảm giá', 'danger');
                appliedCoupon = null;
                calculatedDiscount = 0;
            } finally {
                applyBtn.disabled = false;
                applyBtn.innerHTML = originalText;
            }
        }

        // Remove coupon
        function removeCoupon() {
            appliedCoupon = null;
            calculatedDiscount = 0;
            document.getElementById('couponCode').value = '';
            document.getElementById('couponCode').disabled = false;
            document.getElementById('couponInfo').style.display = 'none';
            document.getElementById('applyCouponBtn').style.display = 'inline-block';
            document.getElementById('couponMessage').innerHTML = '';

            // Update summary
            if (cart) {
                updateSummary(cart.subtotal, 0, cart.subtotal);
            }
        }

        // Show coupon message
        function showCouponMessage(message, type) {
            const msgDiv = document.getElementById('couponMessage');
            msgDiv.innerHTML = `<small class="text-${type}">${message}</small>`;

            if (type === 'success') {
                setTimeout(() => {
                    msgDiv.innerHTML = '';
                }, 3000);
            }
        }

        // Add Enter key support for coupon input
        document.addEventListener('DOMContentLoaded', function() {
            const couponInput = document.getElementById('couponCode');
            if (couponInput) {
                couponInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        applyCoupon();
                    }
                });
            }
        });

        async function updateQuantity(itemId, newQuantity) {
            if (newQuantity < 1) {
                removeItem(itemId);
                return;
            }

            try {
                const response = await fetchWithAuth(`/api/cart/items/${itemId}?quantity=${newQuantity}`, {
                    method: 'PUT'
                });

                if (response.ok) {
                    loadCart();
                } else {
                    alert('Không thể cập nhật số lượng');
                }
            } catch (error) {
                console.error('Error updating quantity:', error);
                alert('Có lỗi xảy ra');
            }
        }

        async function removeItem(itemId) {
            if (!confirm('Bạn có chắc muốn xóa sản phẩm này?')) return;

            try {
                const response = await fetchWithAuth(`/api/cart/items/${itemId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    loadCart();
                } else {
                    alert('Không thể xóa sản phẩm');
                }
            } catch (error) {
                console.error('Error removing item:', error);
                alert('Có lỗi xảy ra');
            }
        }

        async function clearCart() {
            if (!confirm('Bạn có chắc muốn xóa toàn bộ giỏ hàng?')) return;

            try {
                const response = await fetchWithAuth('/api/cart', {
                    method: 'DELETE'
                });

                if (response.ok) {
                    loadCart();
                } else {
                    alert('Không thể xóa giỏ hàng');
                }
            } catch (error) {
                console.error('Error clearing cart:', error);
                alert('Có lỗi xảy ra');
            }
        }

        function checkout() {
            new bootstrap.Modal(document.getElementById('checkoutModal')).show();
        }

        async function submitOrder() {
            const form = document.getElementById('checkoutForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            // Get cart items for order
            let cartItems = [];
            try {
                const itemsResponse = await fetchWithAuth('/api/cart/items-for-order');
                if (itemsResponse.ok) {
                    cartItems = await itemsResponse.json();
                } else {
                    alert('Không thể lấy thông tin giỏ hàng');
                    return;
                }
            } catch (error) {
                console.error('Error fetching cart items:', error);
                alert('Có lỗi xảy ra khi lấy thông tin giỏ hàng');
                return;
            }

            if (!cartItems || cartItems.length === 0) {
                alert('Giỏ hàng trống, không thể đặt hàng');
                return;
            }

            const orderData = {
                items: cartItems,
                shipName: document.getElementById('shipName').value,
                shipPhone: document.getElementById('shipPhone').value,
                shipLine1: document.getElementById('shipLine1').value,
                shipWard: document.getElementById('shipWard').value,
                shipDistrict: document.getElementById('shipDistrict').value,
                shipCity: document.getElementById('shipCity').value,
                shipCountry: 'Vietnam',
                note: document.getElementById('orderNote').value,
                paymentMethod: document.querySelector('input[name="paymentMethod"]:checked').value,
                couponCode: appliedCoupon ? appliedCoupon.code : ''
            };

            try {
                const response = await fetchWithAuth('/api/orders', {
                    method: 'POST',
                    body: JSON.stringify(orderData)
                });

                if (response.ok) {
                    const order = await response.json();
                    bootstrap.Modal.getInstance(document.getElementById('checkoutModal')).hide();

                    // Check payment method
                    if (orderData.paymentMethod === 'VNPAY') {
                        // Redirect to VNPay payment
                        try {
                            const paymentResponse = await fetchWithAuth(`/api/payment/vnpay/create?orderId=${order.id}`, {
                                method: 'POST'
                            });

                            if (paymentResponse.ok) {
                                const paymentData = await paymentResponse.json();
                                // Redirect to our payment redirect page to suppress VNPay errors
                                window.location.href = '/payment/redirect?url=' + encodeURIComponent(paymentData.paymentUrl);
                            } else {
                                alert('Không thể tạo link thanh toán VNPay');
                            }
                        } catch (error) {
                            console.error('Error creating VNPay payment:', error);
                            alert('Có lỗi xảy ra khi tạo thanh toán');
                        }
                    } else {
                        // COD payment - redirect to orders page
                        alert('Đặt hàng thành công! Mã đơn hàng: ' + order.code);
                        window.location.href = '/orders';
                    }
                } else {
                    const error = await response.json();
                    alert('Không thể đặt hàng: ' + (error.message || 'Lỗi không xác định'));
                }
            } catch (error) {
                console.error('Error submitting order:', error);
                alert('Có lỗi xảy ra khi đặt hàng');
            }
        }

        function showError(message) {
            const container = document.getElementById('cartItems');
            container.innerHTML = `
                <div class="text-center py-5">
                    <i class="bi bi-exclamation-triangle text-danger" style="font-size: 5rem;"></i>
                    <p class="text-danger mt-3">${message}</p>
                </div>
            `;
        }

        function formatCurrency(amount) {
            if (amount === null || amount === undefined) return '0 ₫';
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/login';
        }

        // Initialize
        loadCart();
    </script>
</body>
</html>
